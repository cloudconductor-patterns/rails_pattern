#!/usr/bin/env ruby

require 'find'
require 'open3'
require 'json'
require 'fileutils'

class EventHandler

    @@cloudconductor_path = '/opt/cloudconductor'
    @@patterns_path = "#{@@cloudconductor_path}/patterns"
    @@pluginhook_path = '/usr/local/bin/pluginhook'
    @@parameters_file_path = "#{@@cloudconductor_path}/parameters.json"
    @@read_size = 1024

    def get_new_parameters
        new_parameters = {}
        begin
            new_parameters = JSON.parse STDIN.read(@@read_size)
        rescue
        end
        new_parameters
    end

    def update_parameters_file
        parameters = {}
        begin
            parameters = open(@@parameters_file_path) do |io|
                JSON.load(io)
            end
        rescue
        end
        parameters.merge! get_new_parameters
        open(@@parameters_file_path, 'w') do |io|
            JSON.dump(parameters, io)
        end
    end

    def exec
        Dir.entries(@@patterns_path).select do |entry|
            path = File.join(@@patterns_path, entry)
            if (File.directory? path) and !((entry =='.') || (entry == '..')) then
                event = ENV['SERF_EVENT']
                if event == "user"
                    event = "user-#{ENV['SERF_USER_EVENT']}"
                    update_parameters_file
                elsif event == "quesy"
                    event = "query-#{ENV['SERF_QUERY']}"
                    update_parameters_file
                end
                ENV['PLUGIN_PATH'] = "#{path}/events"
                out, err, status = Open3.capture3("#{@@pluginhook_path} #{event}")
            end
        end
    end
end

EventHandler.new().exec
