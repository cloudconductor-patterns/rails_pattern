environments:
  HOME: /root
  PATH: $PATH:/opt/chefdk/embedded/bin:/opt/chef/embedded/bin:/usr/bin
  ROLE: '{{config.role}}'
  CONSUL_SECRET_KEY: '{{config.token}}'

variables:
  backup_directory: /var/cloudconductor/backups/mysql

default:
  timeout: 1800

events:
  setup:
    description: Execute setup
    task: setup

  configure:
    description: Execute configure chef
    task: configure

  spec:
    description: Execute spec
    task: spec

  deploy:
    description: Execute deploy
    task: deploy

  backup:
    description: Execute backup
    priority: 20
    ordered_tasks:
      - service: mysql
        task: backup

  restore:
    description: Execute restore
    priority: 80
    ordered_tasks:
      - service: mysql
        task: restore

tasks:
  setup:
    description: Execute setup chef
    operations:
      - execute:
          file: prepare.sh
      - chef:
          run_list:
            - role[{{role}}_setup]

  configure:
    description: Execute configure chef
    operations:
      - chef:
          run_list:
            - role[{{role}}_configure]

  spec:
    description: Execute serverspec
    operations:
      - execute:
          script: python lib/event_handler.py {{role}} spec

  deploy:
    description: Execute deploy chef
    operations:
      - chef:
          run_list:
            - role[{{role}}_deploy]

  backup:
    description: Backup database
    operations:
      - consul-kvs:
          action: get
          key: cloudconductor/parameters
          name: parameters_json
      - execute:
          script: |
            sudo mkdir -p {{backup_directory}}
            sudo chmod 777 {{backup_directory}}
            SALT=`echo '{{parameters_json}}' | jq '.cloudconductor.salt'`
            PASSWORD=`/opt/chefdk/embedded/bin/ruby -e "require 'openssl'; puts OpenSSL::Digest::SHA256.hexdigest('${SALT}' + 'database')"`
            sudo -u mysql mysqldump -u application -p${PASSWORD} -x --all-databases > /var/cloudconductor/backups/mysql/dump.sql

  restore:
    description: Restore database
    operations:
      - consul-kvs:
          action: get
          key: cloudconductor/parameters
          name: parameters_json
      - execute:
          script: |
            if [ -f {{backup_directory}}/dump.sql ]; then
              SALT=`echo '{{parameters_json}}' | jq '.cloudconductor.salt'`
              PASSWORD=`/opt/chefdk/embedded/bin/ruby -e "require 'openssl'; puts OpenSSL::Digest::SHA256.hexdigest('${SALT}' + 'database')"`
              sudo -u mysql mysql -u application -p${PASSWORD} < /var/cloudconductor/backups/mysql/dump.sql
            fi
